<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Stroboskop-Video</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: black;
            display: flex;
            flex-direction: column;
        }

        #camera-container,
        #strobe-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        video,
        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #shutter {
            width: 70px;
            height: 70px;
            background: red;
            border-radius: 50%;
            cursor: pointer;
        }

        #shutter.active {
            background: darkred;
        }

        #interval-slider {
            width: 200px;
        }
    </style>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    <script>
        function onOpenCvReady() {
            console.log('OpenCV.js ist geladen.');
            // Hier kannst du alles initialisieren, z.B. Video, Canvas, Frames-Array
            cv['onRuntimeInitialized'] = () => {
                console.log('OpenCV.js ready');
            }
            console.log('onOpenCvReady called');
        }
    </script>
</head>

<body>

    <!-- Live-Video -->
    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="controls">
            <div id="shutter"></div>
        </div>
    </div>

    <!-- Stroboskopbild -->
    <div id="strobe-container" style="display:none; flex-direction:column; align-items:center;">
        <img id="strobe-img" />
        <canvas id="canvasStrobe" width="640" height="480" style="display:block;"></canvas>
        <input type="range" id="interval-slider" min="1" max="10" value="3" />
        <span id="interval-value">3</span>
    </div>

    <script>


        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM fully loaded and parsed');
            const video = document.getElementById('video');
            const shutter = document.getElementById('shutter');
            const strobeContainer = document.getElementById('strobe-container');
            const strobeImg = document.getElementById('strobe-img');
            const intervalSlider = document.getElementById('interval-slider');
            const intervalValue = document.getElementById('interval-value');
            const cameraContainer = document.getElementById('camera-container');

            // Live-Video starten
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, frameRate: 30 } });
                video.srcObject = stream;
            } catch (err) {
                alert("Kamera konnte nicht geöffnet werden: " + err);
                return;
            }

            let recording = false;
            let frames = [];

            intervalSlider.addEventListener('input', () => {
                intervalValue.textContent = intervalSlider.value;
                updateStrobe(parseInt(intervalSlider.value));
            });

            shutter.addEventListener('click', () => {
                if (!recording) {
                    // Aufnahme starten
                    recording = true;
                    shutter.classList.add('active');
                    frames = [];

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;


                    const captureFrame = () => {
                        if (!recording) return;

                        // Bild ins Canvas zeichnen
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // cv.Mat
                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let matRGBA = cv.matFromImageData(imageData);
                        let matRGB = new cv.Mat();
                        cv.cvtColor(matRGBA, matRGB, cv.COLOR_RGBA2RGB); // jetzt 3 Kanäle
                        matRGBA.delete();
                        matRGB.convertTo(matRGB, cv.CV_32F);

                        // Frame puffern
                        frames.push(matRGB);

                        // nächstes Frame
                        requestAnimationFrame(captureFrame);
                    }
                    captureFrame();

                } else {
                    // Aufnahme stoppen
                    recording = false;
                    shutter.classList.remove('active');

                    // Live-Bild ausblenden
                    cameraContainer.style.display = 'none';
                    strobeContainer.style.display = 'flex';
                    shutter.style.display = 'none';

                    // Slider-Wert anzeigen
                    intervalValue.textContent = intervalSlider.value;

                    updateStrobe(parseInt(intervalSlider.value));
                }
            });

            function updateStrobe(interval) {
                if (frames.length === 0) return;


                // 1. Frames auswählen
                let selected = [];
                for (let i = 0; i < frames.length; i += interval) {
                    let mat = frames[i];
                    let mat32 = new cv.Mat();
                    mat.convertTo(mat32, cv.CV_32F);
                    selected.push(mat32);
                }

                let background = selected[0].clone();
                for (let i = 1; i < selected.length; i++) {
                    let mat = selected[i];
                    cv.add(background, mat, background);

                }
                let scalar = new cv.Mat(background.rows, background.cols, background.type(), new cv.Scalar(1.0 / selected.length, 1.0 / selected.length, 1.0 / selected.length, 1.0));
                cv.multiply(background, scalar, background);
                scalar.delete();

                // 3. Maximale Abweichung pro Pixel
                const rows = selected[0].rows;
                const cols = selected[0].cols;
                const maxDiff = new cv.Mat.zeros(rows, cols, selected[0].type());
                const maxAbsDiff = new cv.Mat.zeros(rows, cols, cv.CV_32F);
                selected.forEach(f => {
                    const diff = new cv.Mat();
                    cv.subtract(f, background, diff);

                    const absDiff3 = new cv.Mat();
                    cv.absdiff(f, background, absDiff3);
                    const absDiffChannels = new cv.MatVector();
                    cv.split(absDiff3, absDiffChannels);
                    const absDiff = new cv.Mat();
                    cv.max(absDiffChannels.get(0), absDiffChannels.get(1), absDiff);
                    cv.max(absDiff, absDiffChannels.get(2), absDiff);
                    absDiffChannels.get(0).delete();
                    absDiffChannels.get(1).delete();
                    absDiffChannels.get(2).delete();
                    absDiffChannels.delete();
                    absDiff3.delete();

                    const mask = new cv.Mat();
                    cv.compare(absDiff, maxAbsDiff, mask, cv.CMP_GT);
                    diff.copyTo(maxDiff, mask);
                    absDiff.copyTo(maxAbsDiff, mask);

                    diff.delete();
                    absDiff.delete();
                    mask.delete();
                });

                const strobeMat = selected[0].clone();
                cv.add(strobeMat, maxDiff, strobeMat);

                // 4. Anzeige
                const strobeDisplay = new cv.Mat();
                strobeMat.convertTo(strobeDisplay, cv.CV_8U, 1, 0);
                cv.imshow('canvasStrobe', strobeDisplay);

                // 5. Cleanup
                selected.forEach(f => f.delete());
                background.delete();
                strobeMat.delete();
                strobeDisplay.delete();
                maxDiff.delete();
                maxAbsDiff.delete();
            }


        });
    </script>
</body>

</html>