<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Stroboskop-Video</title>
<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; background:black; display:flex; flex-direction:column; }
  #camera-container, #strobe-container { flex:1; display:flex; justify-content:center; align-items:center; position:relative; }
  video, img { width:100%; height:100%; object-fit:cover; }
  #controls { position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; align-items:center; gap:10px; }
  #shutter { width:70px; height:70px; background:red; border-radius:50%; cursor:pointer; }
  #shutter.active { background:darkred; }
  #interval-slider { width:200px; }
</style>
</head>
<body>

<!-- Live-Video -->
<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <div id="controls">
    <div id="shutter"></div>
  </div>
</div>

<!-- Stroboskopbild -->
<div id="strobe-container" style="display:none; flex-direction:column; align-items:center;">
  <img id="strobe-img" />
  <input type="range" id="interval-slider" min="1" max="10" value="3" />
  <span id="interval-value">3</span>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const video = document.getElementById('video');
  const shutter = document.getElementById('shutter');
  const strobeContainer = document.getElementById('strobe-container');
  const strobeImg = document.getElementById('strobe-img');
  const intervalSlider = document.getElementById('interval-slider');
  const intervalValue = document.getElementById('interval-value');
  const cameraContainer = document.getElementById('camera-container');

  // Live-Video starten
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, frameRate: 30 } });
    video.srcObject = stream;
  } catch(err) {
    alert("Kamera konnte nicht geöffnet werden: " + err);
    return;
  }

  let recording = false;
  let frames = [];

  intervalSlider.addEventListener('input', () => {
    intervalValue.textContent = intervalSlider.value;
    updateStrobe(parseInt(intervalSlider.value));
  });

  shutter.addEventListener('click', () => {
    if(!recording){
      // Aufnahme starten
      recording = true;
      shutter.classList.add('active');
      frames = [];

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const captureFrame = () => {
        if(!recording) return;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        frames.push(ctx.getImageData(0,0,canvas.width,canvas.height));
        requestAnimationFrame(captureFrame);
      }
      captureFrame();

    } else {
      // Aufnahme stoppen
      recording = false;
      shutter.classList.remove('active');

      // Live-Bild ausblenden
      cameraContainer.style.display = 'none';
      strobeContainer.style.display = 'flex';
      shutter.style.display = 'none';

      // Slider-Wert anzeigen
      intervalValue.textContent = intervalSlider.value;

      updateStrobe(parseInt(intervalSlider.value));
    }
  });

  function updateStrobe(interval) {
    if(frames.length === 0) return;
    const width = frames[0].width;
    const height = frames[0].height;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = width;
    canvas.height = height;
    const out = ctx.createImageData(width,height);

    for(let i=0; i<frames.length-interval; i+=interval){
      const f1 = frames[i];
      const f2 = frames[i+interval];
      for(let j=0; j<f1.data.length; j+=4){
        // Absolute Differenz auf RGB-Kanäle
        out.data[j]   = Math.min(255, Math.abs(f2.data[j] - f1.data[j]));
        out.data[j+1] = Math.min(255, Math.abs(f2.data[j+1] - f1.data[j+1]));
        out.data[j+2] = Math.min(255, Math.abs(f2.data[j+2] - f1.data[j+2]));
        out.data[j+3] = 255;
      }
      ctx.putImageData(out,0,0);
    }
    strobeImg.src = canvas.toDataURL('image/png');
  }

});
</script>
</body>
</html>
