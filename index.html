<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Stroboskop-Video</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: black;
            display: flex;
            flex-direction: column;
        }

        #camera-container,
        #strobe-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        video,
        canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        #shutter {
            width: 70px;
            height: 70px;
            background: red;
            border-radius: 50%;
            cursor: pointer;
        }

        #shutter.active {
            background: darkred;
        }

        #interval-slider {
            width: 200px;
        }
    </style>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    <script type="module" src="strobo.js"></script>
    <script>
        function onOpenCvReady() {
            console.log('OpenCV.js ist geladen.');
            // Hier kannst du alles initialisieren, z.B. Video, Canvas, Frames-Array
            cv['onRuntimeInitialized'] = () => {
                console.log('OpenCV.js ready');
            }
            console.log('onOpenCvReady called');
        }
    </script>
</head>

<body>

    <!-- Live-Video -->
    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="controls">
            <div id="shutter"></div>
            <button id="toggle-camera">Frontkamera</button>
        </div>
    </div>

    <!-- Stroboskopbild -->
    <div id="strobe-container" style="display:none; flex-direction:column; align-items:center;">
        <canvas id="canvasStrobe"></canvas>
        <div id="controls">
            <input type="range" id="interval-slider" min="1" max="10" value="3" />
            <span id="interval-value">3</span>
        </div>
    </div>

    <script type="module">

        import { createStroboEvaluation } from './strobo.js';

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM fully loaded and parsed');

            const video = document.getElementById('video');
            const shutter = document.getElementById('shutter');
            const toggleBtn = document.getElementById('toggle-camera');
            const strobeContainer = document.getElementById('strobe-container');
            const intervalSlider = document.getElementById('interval-slider');
            const intervalValue = document.getElementById('interval-value');
            const cameraContainer = document.getElementById('camera-container');

            let usingFront = true; // Frontkamera aktiv
            let currentStream;
            let recording = false;
            let frames = [];
            let stroboEvaluation;

            async function startCamera() {
                if (currentStream) {
                    // Alte Streams stoppen
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const facingMode = usingFront ? 'user' : 'environment';

                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480, frameRate: 30, facingMode }
                    });
                    video.srcObject = currentStream;
                } catch (err) {
                    alert("Kamera konnte nicht geöffnet werden: " + err);
                }
            }

            // Toggle-Button Event
            toggleBtn.addEventListener('click', () => {
                usingFront = !usingFront;
                toggleBtn.textContent = usingFront ? 'Frontkamera' : 'Rückkamera';
                startCamera();
            });

            intervalSlider.addEventListener('input', () => {
                intervalValue.textContent = intervalSlider.value;
                if (stroboEvaluation) {
                    stroboEvaluation.updateStrobe('canvasStrobe', parseInt(intervalSlider.value));
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.code === 'VolumeUp' || e.code === 'VolumeDown') {
                    onShutter();
                }
            });

            shutter.addEventListener('click', onShutter);

            function onShutter() {
                if (!recording) {
                    // Aufnahme starten
                    recording = true;
                    shutter.classList.add('active');
                    frames = [];

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;


                    const captureFrame = () => {
                        if (!recording) return;

                        // Bild ins Canvas zeichnen
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        frames.push(imageData);

                        // nächstes Frame
                        requestAnimationFrame(captureFrame);
                    }
                    captureFrame();

                } else {
                    // Aufnahme stoppen
                    recording = false;
                    shutter.classList.remove('active');

                    // Live-Bild ausblenden
                    cameraContainer.style.display = 'none';
                    strobeContainer.style.display = 'flex';
                    shutter.style.display = 'none';

                    // Slider-Wert anzeigen
                    intervalValue.textContent = intervalSlider.value;

                    stroboEvaluation = createStroboEvaluation(frames);
                    stroboEvaluation.updateStrobe('canvasStrobe', parseInt(intervalSlider.value));
                }
            }

            startCamera();

        });
    </script>
</body>

</html>